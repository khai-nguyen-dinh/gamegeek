---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
import { load } from 'js-yaml';
import { getContentObject } from '../utils/content.ts';

// Helper to parse frontmatter from mdoc content
function parseFrontmatter(content: string) {
  const frontmatterRegex = /^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/;
  const match = content.match(frontmatterRegex);
  if (!match) return { data: {}, content: content.trim() };

  const yamlContent = match[1];
  const bodyContent = match[2];

  try {
    const data = load(yamlContent) as any;
    return { data: data || {}, content: bodyContent.trim() };
  } catch (error) {
    return { data: {}, content: bodyContent.trim() };
  }
}

// Fetch raw file from GitHub (works in build and runtime)
async function fetchFromGitHub(path: string): Promise<string | null> {
  try {
    const repo = 'khai-nguyen-dinh/gamegeek';
    const branch = 'main';
    const url = `https://raw.githubusercontent.com/${repo}/${branch}/${path}`;
    const response = await fetch(url);
    if (response.ok) {
      return await response.text();
    }
    return null;
  } catch (error) {
    console.error(`Error fetching from GitHub: ${path}`, error);
    return null;
  }
}

// List files in a GitHub directory
async function listGitHubFiles(path: string): Promise<string[]> {
  try {
    const repo = 'khai-nguyen-dinh/gamegeek';
    const branch = 'main';
    const url = `https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`;
    const response = await fetch(url);
    if (response.ok) {
      const files = await response.json();
      if (Array.isArray(files)) {
        return files.filter((file: any) => file.type === 'file').map((file: any) => file.name);
      }
    }
    return [];
  } catch (error) {
    console.error(`Error listing GitHub files: ${path}`, error);
    return [];
  }
}

// Read a single post mdoc by slug
async function readMdocFile(slug: string) {
  if (!slug) return null;
  const fileContent = await fetchFromGitHub(`src/keystatic/posts/${slug}.mdoc`);
  if (!fileContent) return null;

  const { data, content: fileContentBody } = parseFrontmatter(fileContent);
  if (!data || Object.keys(data).length === 0) return null;

  return {
    ...data,
    content: fileContentBody || '',
    slug,
  };
}

// Get all posts from Keystatic (via GitHub)
async function getAllPosts() {
  const files = await listGitHubFiles('src/keystatic/posts');
  const mdocFiles = files.filter((f) => f.endsWith('.mdoc'));

  const posts = await Promise.all(
    mdocFiles.map(async (file) => {
      const slug = file.replace('.mdoc', '');
      const post = await readMdocFile(slug);
      if (post) post.slug = slug;
      return post;
    })
  );
  return posts.filter((p) => p !== null);
}

// Get all categories from Keystatic (via GitHub)
async function getAllCategories() {
  const files = await listGitHubFiles('src/keystatic/categories');
  const yamlFiles = files.filter((f) => f.endsWith('.yaml'));

  const categories = await Promise.all(
    yamlFiles.map(async (file) => {
      const slug = file.replace('.yaml', '');
      const content = await fetchFromGitHub(`src/keystatic/categories/${slug}.yaml`);
      if (!content) return null;
      try {
        const data = load(content) as any;
        return {
          id: data.id,
          name: data.name,
          slug,
        };
      } catch (error) {
        return null;
      }
    })
  );
  return categories.filter((c) => c !== null);
}

// Helpers for date handling
const getDateTime = (value: any) => {
  if (!value) return 0;
  if (value instanceof Date) return value.getTime();
  if (typeof value === 'string') {
    const parsed = new Date(value);
    return Number.isNaN(parsed.getTime()) ? 0 : parsed.getTime();
  }
  return 0;
};

const getDisplayDate = (value: any) => {
  const time = getDateTime(value);
  if (!time) return { displayDay: '', displayMonth: '' };
  const dateObj = new Date(time);
  const day = String(dateObj.getDate());
  const month = dateObj.toLocaleString('en-US', { month: 'short' });
  return { displayDay: day, displayMonth: month };
};

const newsContent = getContentObject('news');
const breadcrumb = newsContent?.breadcrumb || {};
const sidebar = newsContent?.sidebar || {};

// Load categories and posts from Keystatic (GitHub)
const categories = await getAllCategories();
const categoryMap = new Map(categories.map((cat) => [cat.id, cat.name]));
const categorySlugToIdMap = new Map(categories.map((cat) => [cat.slug, cat.id]));

const allPosts = await getAllPosts();
const postsWithMeta = allPosts.map((post) => {
  const categoryId = post.category;
  const categoryName = categoryMap.get(categoryId) || categoryId;
  const { displayDay, displayMonth } = getDisplayDate(post.date);
  return {
    ...post,
    categoryId,
    category: categoryName,
    displayDay,
    displayMonth,
    // Map image to thumb for compatibility
    thumb: post.image || post.thumb || '',
  };
});

// Get category filter from URL query parameter
const categorySlug = Astro.url.searchParams.get('category');
const selectedCategoryId = categorySlug ? categorySlugToIdMap.get(categorySlug) : null;

// Filter posts by category if category is selected
let filteredPosts = postsWithMeta;
if (selectedCategoryId) {
  filteredPosts = postsWithMeta.filter((post) => post.categoryId === selectedCategoryId);
}

// Sort posts by date (newest first)
const sortedPosts = [...filteredPosts].sort((a, b) => getDateTime(b.date) - getDateTime(a.date));

// Get recent posts (first 3)
const recentPosts = sortedPosts.slice(0, 3);

// Split posts for layout
const featuredPost = sortedPosts[0];
const twoByTwoPosts = sortedPosts.slice(1, 5);
const verticalPosts = sortedPosts.slice(5, 8);

// Count posts per category (based on all posts)
const categoryCounts = new Map<string, number>();
postsWithMeta.forEach((post) => {
  const count = categoryCounts.get(post.categoryId) || 0;
  categoryCounts.set(post.categoryId, count + 1);
});
---

<Layout title="Blog Left Sidebar | GameGeek">

<!-- Custom Cursor -->
<div class="cursor"><span class="cursor-text"></span></div>
<div class="cursor-inner"></div>

<div id="smooth-wrapper">
  <div id="smooth-content">
    <!-- Navbar Start -->
    <Navbar variant="white" />
    <!-- Navbar End -->

    <!-- Breadcrumb Section Start -->
    <div class="breadcrumb-area position-relative z-1">
      <img src="/renius/image/br-line-shape.png" alt="Shape" class="br-line-shape position-absolute top-0 start-0 w-100 h-100 z-n1">
      <img src="/renius/image/br-shape-1.png" alt="Shape" class="br-shape-one position-absolute z-n1 bounce">
      <img src="/renius/image/br-shape-2.png" alt="Shape" class="br-shape-two position-absolute bottom-0 z-n1 moveHorizontal">
      <div class="container-fluid px-xxl-5">
        <div class="row">
          <div class="col-md-10 offset-md-1 text-center">
            <h2 class="section-title style-one fw-black text-title">{breadcrumb.title || 'NEWS & INSIGHTS'}</h2>
            <ul class="br-menu list-unstyled">
              <li><a href="/"><img src="/renius/image/home-icon.svg" alt="Icon">{breadcrumb.home || 'HOME'}</a></li>
              <li>{breadcrumb.current || 'BLOG'}</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <!-- Breadcrumb Section End -->

    <!-- Blog Section Start -->
    <div class="container ptb-120">
      <div class="row">
        <div class="col-xl-4 order-xl-1 order-2">
          <aside class="sidebar mt-lg-50">
            <div class="sidebar-widget search-widget bg-gray round-10">
              <form action="#" class="position-relative">
                <input type="search" placeholder={sidebar.search?.placeholder || 'Search'} class="w-100 bg-white border-0 round-10 text-para outline-0">
                <button class="position-absolute top-0 h-100 bg-transparent border-0"><i class="ri-search-line"></i></button>
              </form>
            </div>
            <div class="sidebar-widget category-widget bg-gray round-10">
              <h3 class="sidebar-widget-title fs-18 fw-semibold text-title mb-15">{sidebar.categories?.title || 'Categories'}</h3>
              <ul class="list-unstyled mb-0">
                {categories.map(cat => {
                  const count = categoryCounts.get(cat.id) || 0;
                  return (
                    <li>
                      <a href={`/news?category=${cat.slug}`} class="position-relative">
                        <i class="ri-arrow-right-s-line position-absolute"></i>
                        {cat.name} <span>({count})</span>
                      </a>
                    </li>
                  );
                })}
              </ul>
            </div>
            <div class="sidebar-widget category-widget bg-gray round-10">
              <h3 class="sidebar-widget-title fs-18 fw-semibold text-title mb-15">{sidebar.recentPosts?.title || 'Recent Posts'}</h3>
              <div class="rp-post-wrap">
                {recentPosts.map(post => (
                  <div class="rp-post-card d-flex flex-wrap align-items-center">
                    <div class="rp-post-img">
                      <img src={post.thumb} alt="Post Thumb">
                    </div>
                    <div class="rp-post-info">
                      <a href={`/news/${post.slug}`} class="fs-15 fw-medium text_primary link-hover-primary d-block mb-1">{post.date}</a>
                      <h5 class="fs-15 fw-bold mb-0">
                        <a href={`/news/${post.slug}`} class="text-title hover-text-primary transition">{post.title}</a>
                      </h5>
                    </div>
                  </div>
                ))}
              </div>
            </div>
            <div class="sidebar-widget tags-widget bg-gray round-10">
              <h3 class="sidebar-widget-title fs-18 fw-semibold text-title mb-15">{sidebar.tags?.title || 'Tags'}</h3>
              <ul class="list-unstyled mb-0">
                {(sidebar.tags?.items || ['Business', 'Development', 'Design', 'Marketing', 'Real Estate']).map((tag) => (
                  <li><a href="#">{tag}</a></li>
                ))}
              </ul>
            </div>
          </aside>
        </div>

        <div class="col-xl-8 order-xl-2 order-1">
          <!-- Featured Post (News 1) - Large Box -->
          {featuredPost && (
            <div class="mb-40">
              <div class="blog-card style-one position-relative">
                <div class="blog-img position-relative overflow-hidden round-20">
                  <img src={featuredPost.thumb} alt="Blog" class="round-20 w-100" style="height: 400px; object-fit: cover;">
                  <a href={`/news/${featuredPost.slug}`} class="blog-date bg-white text-title position-absolute d-flex flex-column align-items-center justify-content-center round-10">
                    <span class="font-secondary fs-24 fw-black d-block">{featuredPost.displayDay}</span> {featuredPost.displayMonth}
                  </a>
                </div>
                <ul class="blog-metainfo list-unstyled mt-3">
                  <li class="fs-15 d-inline-block position-relative">By <a href="#">{featuredPost.author}</a></li>
                  <li class="fs-15 d-inline-block position-relative">{featuredPost.category}</li>
                </ul>
                <h3 class="fs-28 fw-black mt-2">
                  <a href={`/news/${featuredPost.slug}`} class="text-title link-hover-primary fw-bold transition">{featuredPost.title}</a>
                </h3>
                <a href={`/news/${featuredPost.slug}`} class="link style-one fw-semibold">{newsContent.readMore || 'Read More'}<img src="/renius/image/right-arrow-small.svg" alt="Icon"></a>
              </div>
            </div>
          )}

          <!-- Two Rows of 2 Posts Each (News 2) -->
          {twoByTwoPosts.length > 0 && (
            <>
              {/* First Row - 2 Posts */}
              <div class="row mb-30">
                {twoByTwoPosts.slice(0, 2).map(post => (
                  <div class="col-md-6">
                    <div class="blog-card style-one position-relative mb-30">
                      <div class="blog-img position-relative overflow-hidden round-20">
                        <img src={post.thumb} alt="Blog" class="round-20 w-100" style="height: 280px; object-fit: cover;">
                        <a href={`/news/${post.slug}`} class="blog-date bg-white text-title position-absolute d-flex flex-column align-items-center justify-content-center round-10">
                          <span class="font-secondary fs-24 fw-black d-block">{post.displayDay}</span> {post.displayMonth}
                        </a>
                      </div>
                      <ul class="blog-metainfo list-unstyled">
                        <li class="fs-15 d-inline-block position-relative">By <a href="#">{post.author}</a></li>
                        <li class="fs-15 d-inline-block position-relative">{post.category}</li>
                      </ul>
                      <h3 class="fs-24 fw-black">
                        <a href={`/news/${post.slug}`} class="text-title link-hover-primary fw-bold transition">{post.title}</a>
                      </h3>
                      <a href={`/news/${post.slug}`} class="link style-one fw-semibold">Read More<img src="/renius/image/right-arrow-small.svg" alt="Icon"></a>
                    </div>
                  </div>
                ))}
              </div>

              {/* Second Row - 2 Posts */}
              <div class="row mb-30">
                {twoByTwoPosts.slice(2, 4).map(post => (
                  <div class="col-md-6">
                    <div class="blog-card style-one position-relative mb-30">
                      <div class="blog-img position-relative overflow-hidden round-20">
                        <img src={post.thumb} alt="Blog" class="round-20 w-100" style="height: 280px; object-fit: cover;">
                        <a href={`/news/${post.slug}`} class="blog-date bg-white text-title position-absolute d-flex flex-column align-items-center justify-content-center round-10">
                          <span class="font-secondary fs-24 fw-black d-block">{post.displayDay}</span> {post.displayMonth}
                        </a>
                      </div>
                      <ul class="blog-metainfo list-unstyled">
                        <li class="fs-15 d-inline-block position-relative">By <a href="#">{post.author}</a></li>
                        <li class="fs-15 d-inline-block position-relative">{post.category}</li>
                      </ul>
                      <h3 class="fs-24 fw-black">
                        <a href={`/news/${post.slug}`} class="text-title link-hover-primary fw-bold transition">{post.title}</a>
                      </h3>
                      <a href={`/news/${post.slug}`} class="link style-one fw-semibold">Read More<img src="/renius/image/right-arrow-small.svg" alt="Icon"></a>
                    </div>
                  </div>
                ))}
              </div>
            </>
          )}

          <!-- Three Vertical Posts (3) - Long Narrow Boxes -->
          {verticalPosts.length > 0 && (
            <div class="vertical-posts">
              {verticalPosts.map(post => (
                <div class="blog-card style-one position-relative mb-30 d-flex flex-row align-items-center">
                  <div class="blog-img position-relative overflow-hidden round-20 me-3" style="width: 200px; min-width: 200px; height: 150px;">
                    <img src={post.thumb} alt="Blog" class="round-20 w-100 h-100" style="object-fit: cover;">
                    <a href={`/news/${post.slug}`} class="blog-date bg-white text-title position-absolute d-flex flex-column align-items-center justify-content-center round-10">
                      <span class="font-secondary fs-20 fw-black d-block">{post.displayDay}</span> {post.displayMonth}
                    </a>
                  </div>
                  <div class="blog-content flex-grow-1">
                    <ul class="blog-metainfo list-unstyled">
                      <li class="fs-15 d-inline-block position-relative">By <a href="#">{post.author}</a></li>
                      <li class="fs-15 d-inline-block position-relative">{post.category}</li>
                    </ul>
                    <h3 class="fs-20 fw-black mb-2">
                      <a href={`/news/${post.slug}`} class="text-title link-hover-primary fw-bold transition">{post.title}</a>
                    </h3>
                    <a href={`/news/${post.slug}`} class="link style-one fw-semibold">Read More<img src="/renius/image/right-arrow-small.svg" alt="Icon"></a>
                  </div>
                </div>
              ))}
            </div>
          )}

          <!-- Remaining Posts (if any) -->
          {sortedPosts.length > 8 && (
            <div class="row justify-content-center mt-4">
              {sortedPosts.slice(8).map(post => (
                <div class="col-md-6">
                  <div class="blog-card style-one position-relative mb-30">
                    <div class="blog-img position-relative overflow-hidden round-20">
                      <img src={post.thumb} alt="Blog" class="round-20">
                      <a href={`/news/${post.slug}`} class="blog-date bg-white text-title position-absolute d-flex flex-column align-items-center justify-content-center round-10">
                        <span class="font-secondary fs-24 fw-black d-block">{post.displayDay}</span> {post.displayMonth}
                      </a>
                    </div>
                    <ul class="blog-metainfo list-unstyled">
                      <li class="fs-15 d-inline-block position-relative">By <a href="#">{post.author}</a></li>
                      <li class="fs-15 d-inline-block position-relative">{post.category}</li>
                    </ul>
                    <h3 class="fs-24 fw-black">
                      <a href={`/news/${post.slug}`} class="text-title link-hover-primary fw-bold transition">{post.title}</a>
                    </h3>
                    <a href={`/news/${post.slug}`} class="link style-one fw-semibold">Read More<img src="/renius/image/right-arrow-small.svg" alt="Icon"></a>
                  </div>
                </div>
              ))}
            </div>
          )}
          <ul class="page-nav pagination justify-content-center mb-0 mt-lg-4">
            <li class="page-item">
              <a class="page-link d-flex flex-column align-items-center justify-content-center rounded-circle" href="#" aria-label="Previous">
                <i class="ri-arrow-left-line"></i>
              </a>
            </li>
            <li class="page-item"><a class="page-link d-flex flex-column align-items-center justify-content-center rounded-circle active" href="#">01</a></li>
            <li class="page-item"><a class="page-link d-flex flex-column align-items-center justify-content-center rounded-circle" href="#">02</a></li>
            <li class="page-item"><a class="page-link d-flex flex-column align-items-center justify-content-center rounded-circle" href="#">03</a></li>
            <li class="page-item">
              <a class="page-link d-flex flex-column align-items-center justify-content-center rounded-circle" href="#" aria-label="Next">
                <i class="ri-arrow-right-line"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <!-- Blog Details End -->

    <!-- Footer Section Start -->
    <Footer />
    <!-- Footer End -->

  </div>
</div>

</Layout>
