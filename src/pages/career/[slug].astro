---
import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/Navbar.astro';
import Footer from '../../components/Footer.astro';
import { load } from 'js-yaml';

// Helper to parse frontmatter from mdoc content
function parseFrontmatter(content: string) {
  const frontmatterRegex = /^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/;
  let match = content.match(frontmatterRegex);
  
  if (!match) {
    const firstDash = content.indexOf('---\n');
    if (firstDash === 0) {
      const secondDash = content.indexOf('\n---\n', firstDash + 4);
      if (secondDash > 0) {
        const yamlContent = content.substring(4, secondDash);
        const bodyContent = content.substring(secondDash + 5);
        try {
          const data = load(yamlContent) as any;
          return { data: data || {}, content: bodyContent.trim() };
        } catch (error) {
          console.error('Error parsing YAML:', error);
          return { data: {}, content: bodyContent.trim() };
        }
      }
    }
    return { data: {}, content: content.trim() };
  }

  const yamlContent = match[1];
  const bodyContent = match[2];

  try {
    const data = load(yamlContent) as any;
    return { data: data || {}, content: bodyContent.trim() };
  } catch (error) {
    console.error('Error parsing YAML:', error);
    return { data: {}, content: bodyContent.trim() };
  }
}

// Helper to get GitHub token from environment
function getGitHubToken(): string | null {
  try {
    const runtime = (Astro.locals as any)?.runtime;
    const env = runtime?.env || {};
    if (env.GITHUB_TOKEN || env.KEYSTATIC_GITHUB_TOKEN) {
      return env.GITHUB_TOKEN || env.KEYSTATIC_GITHUB_TOKEN;
    }
  } catch (e) {
    // Ignore
  }
  
  return import.meta.env.GITHUB_TOKEN || import.meta.env.KEYSTATIC_GITHUB_TOKEN || null;
}

// Fetch raw file from GitHub
async function fetchFromGitHub(path: string): Promise<string | null> {
  try {
    const repo = 'khai-nguyen-dinh/gamegeek';
    const branch = 'main';
    const url = `https://raw.githubusercontent.com/${repo}/${branch}/${path}`;
    
    const headers: HeadersInit = {
      'Accept': 'application/vnd.github.v3+raw',
      'User-Agent': 'GameGeek-CMS',
    };
    
    const token = getGitHubToken();
    if (token) {
      headers['Authorization'] = `token ${token}`;
    }
    
    const response = await fetch(url, { headers });
    if (response.ok) {
      return await response.text();
    }
    
    return null;
  } catch (error) {
    console.error(`Error fetching from GitHub: ${path}`, error);
    return null;
  }
}

// List files in a GitHub directory
async function listGitHubFiles(path: string): Promise<string[]> {
  try {
    const repo = 'khai-nguyen-dinh/gamegeek';
    const branch = 'main';
    const url = `https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`;
    
    const headers: HeadersInit = {
      'Accept': 'application/vnd.github.v3+json',
      'User-Agent': 'GameGeek-CMS',
    };
    
    const token = getGitHubToken();
    if (token) {
      headers['Authorization'] = `token ${token}`;
    }
    
    const response = await fetch(url, { headers });
    if (response.ok) {
      const files = await response.json();
      if (Array.isArray(files)) {
        return files.map((file: any) => file.name).filter((name: string) => name.endsWith('.mdoc'));
      }
    }
    
    return [];
  } catch (error) {
    console.error(`Error listing GitHub files: ${path}`, error);
    return [];
  }
}

// Read a single career mdoc by slug (local filesystem first, then GitHub)
async function readCareerFile(slug: string) {
  if (!slug) return null;
  
  // Try local filesystem first in development
  const isProduction = import.meta.env.PROD;
  
  if (!isProduction) {
    try {
      const careerModules = import.meta.glob('../../keystatic/careers/*.mdoc?raw', { eager: true });
      const moduleEntries = Object.entries(careerModules);
      
      for (const [path, module] of moduleEntries) {
        const fileSlug = path.split('/').pop()?.replace('.mdoc', '') || '';
        if (fileSlug === slug) {
          let content = '';
          if (typeof module === 'string') {
            content = module;
          } else if (module && typeof module === 'object' && 'default' in module) {
            content = typeof module.default === 'string' ? module.default : '';
          }
          
          if (content) {
            const { data, content: fileContentBody } = parseFrontmatter(content);
            if (data && Object.keys(data).length > 0) {
              return {
                ...data,
                content: fileContentBody || '',
                slug,
              };
            }
          }
        }
      }
    } catch (error) {
      // Silent fail, fallback to GitHub
    }
  }
  
  // Fallback to GitHub API
  const fileContent = await fetchFromGitHub(`src/keystatic/careers/${slug}.mdoc`);
  if (!fileContent) return null;

  const { data, content: fileContentBody } = parseFrontmatter(fileContent);
  if (!data || Object.keys(data).length === 0) return null;

  return {
    ...data,
    content: fileContentBody || '',
    slug,
  };
}

// Get all careers for static paths
export async function getStaticPaths() {
  let careers: any[] = [];
  
  // Try local filesystem first in development
  const isProduction = import.meta.env.PROD;
  
  if (!isProduction) {
    try {
      const careerModules = import.meta.glob('../../keystatic/careers/*.mdoc?raw', { eager: true });
      const moduleEntries = Object.entries(careerModules);
      
      const localCareers = moduleEntries.map((entry) => {
        const path = entry[0];
        const module = entry[1];
        
        let content = '';
        if (typeof module === 'string') {
          content = module;
        } else if (module && typeof module === 'object' && 'default' in module) {
          content = typeof module.default === 'string' ? module.default : '';
        }
        
        if (!content) {
          return null;
        }
        
        try {
          const { data, content: fileContentBody } = parseFrontmatter(content);
          if (!data || Object.keys(data).length === 0) return null;
          
          // Only return active careers
          if (data.active === false) return null;
          
          const slug = path.split('/').pop()?.replace('.mdoc', '') || '';
          return {
            ...data,
            content: fileContentBody || '',
            slug,
          };
        } catch (error) {
          return null;
        }
      }).filter(c => c !== null);
      
      if (localCareers.length > 0) {
        careers = localCareers;
      }
    } catch (error) {
      // Silent fail, fallback to GitHub
    }
  }
  
  // Fallback to GitHub API
  if (careers.length === 0) {
    try {
      const files = await listGitHubFiles('src/keystatic/careers');
      const mdocFiles = files.filter(f => f.endsWith('.mdoc'));
      
      const githubCareers = await Promise.all(
        mdocFiles.map(async (file) => {
          const slug = file.replace('.mdoc', '');
          const career = await readCareerFile(slug);
          if (career && career.active !== false) {
            return career;
          }
          return null;
        })
      );
      
      careers = githubCareers.filter(c => c !== null);
    } catch (error) {
      console.error('Error generating static paths for careers:', error);
      return [];
    }
  }
  
  return careers.map((career) => ({
    params: { slug: career.slug },
    props: career
  }));
}

const { slug } = Astro.params;

// Get current career data - use props if available, otherwise read from file
let careerData = Astro.props;
if (!careerData || !careerData.title) {
  if (slug) {
    careerData = await readCareerFile(slug);
    if (careerData) {
      careerData.slug = slug;
    }
  }
}

// If still no data, return 404
if (!careerData || !careerData.title) {
  return Astro.redirect('/career', 404);
}

const {
  title: rawTitle = '',
  location: rawLocation = '',
  type: rawType = '',
  experience: rawExperience = '',
  deadline = '',
  salary: rawSalary = '',
  description = '',
  content = '',
  responsibilities = [],
  qualifications = [],
  offers = [],
} = careerData;

// Ensure all values are strings
const title = String(rawTitle || '');
const location = String(rawLocation || '');
const type = String(rawType || '');
const experience = String(rawExperience || '');
const salary = String(rawSalary || '');

// Format deadline date if it exists
const formatDeadline = (deadlineValue: any) => {
  if (!deadlineValue) return '';
  if (typeof deadlineValue === 'string') return deadlineValue;
  if (deadlineValue instanceof Date) {
    return deadlineValue.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  }
  // Handle date object from Keystatic
  if (deadlineValue && typeof deadlineValue === 'object') {
    const date = new Date(deadlineValue);
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  }
  return '';
};

const formattedDeadline = formatDeadline(deadline);
const displayDescription = description || content;
const pageTitle = title ? `${title} | GameGeek` : 'Career | GameGeek';
---

<Layout title={pageTitle}>


<!-- Custom Cursor -->
<div class="cursor"><span class="cursor-text"></span></div>
<div class="cursor-inner"></div>

<div id="smooth-wrapper">
  <div id="smooth-content">
    <!-- Navbar Start -->
    <Navbar variant="white" />
    <!-- Navbar End -->

    <!-- Breadcrumb Section Start -->
    <div class="breadcrumb-area position-relative z-1">
      <img src="/renius/image/br-line-shape.png" alt="Shape" class="br-line-shape position-absolute top-0 start-0 w-100 h-100 z-n1">
      <img src="/renius/image/br-shape-1.png" alt="Shape" class="br-shape-one position-absolute z-n1 bounce">
      <img src="/renius/image/br-shape-2.png" alt="Shape" class="br-shape-two position-absolute bottom-0 z-n1 moveHorizontal">
      <div class="container-fluid px-xxl-5">
        <div class="row">
          <div class="col-md-10 offset-md-1 text-center">
            <h2 class="section-title style-one fw-black text-title">CAREER INFO</h2>
            <ul class="br-menu list-unstyled">
              <li><a href="/"><img src="/renius/image/home-icon.svg" alt="Icon">HOME</a></li>
              <li><a href="/career">CAREERS</a></li>
              <li>CAREER INFO</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <!-- Breadcrumb Section End -->

    <!-- Career Info Section Start -->
    <div class="container ptb-120">
      <div class="row">
        <div class="col-xl-8 pe-xxl-4">
          <div class="job-desc">
            <div class="single-img round-10 position-relative">
              <!-- Image can be added here if needed -->
            </div>
            <div class="single-job-title position-relative z-1 bg-white round-10">
              <h1 class="fs-24 fw-bold text-title">{title}</h1>
              <ul class="job-metainfo list-unstyled">
                <li class="position-relative"><i class="ri-map-pin-line"></i><span class="fw-medium text-title me-1">Location:</span> {location}</li>
                <li class="position-relative"><i class="ri-briefcase-line"></i><span class="fw-medium text-title me-1">Type:</span> {type}</li>
                <li class="position-relative"><i class="ri-user-line"></i><span class="fw-medium text-title me-1">Experience:</span> {experience}</li>
              </ul>
            </div>
            <div class="single-para">
              <h6 class="fs-20 fw-bold">Job Description</h6>
              {displayDescription ? (
                <div set:html={displayDescription} />
              ) : (
                <p>{description}</p>
              )}
            </div>
            <div class="single-para">
              <h6 class="fs-20 fw-bold mb-15">Responsibilities:</h6>
              <ul class="feature-list style-two list-unstyled mb-0">
                {responsibilities.map((item) => (
                  <li class="position-relative">{item}</li>
                ))}
              </ul>
            </div>
            <div class="single-para">
              <h6 class="fs-20 fw-bold mb-15">Qualifications:</h6>
              <ul class="feature-list style-two list-unstyled mb-0">
                {qualifications.map((item) => (
                  <li class="position-relative">{item}</li>
                ))}
              </ul>
            </div>
            <div class="single-para">
              <h6 class="fs-20 fw-bold mb-15">What We Offer:</h6>
              <ul class="feature-list style-two list-unstyled mb-30">
                {offers.map((item) => (
                  <li class="position-relative">{item}</li>
                ))}
              </ul>
              <button class="btn style-one d-inline-flex flex-wrap align-items-center p-0"><span class="btn-text d-inline-block fw-semibold position-relative transition">Apply For This job</span><span class="btn-icon position-relative d-flex flex-column align-items-center justify-content-center rounded-circle transition"><i class="ri-arrow-right-up-line"></i></span></button>
            </div>
          </div>
        </div>
        <div class="col-xl-4 ps-xxl-5">
          <div class="sidebar me-xxl-3 mt-lg-50">
            <div class="sidebar-widget bg-gray round-10 p-0">
              <ul class="job-brief list-unstyled">
                {formattedDeadline && (
                  <li>
                    <span class="text-title fw-semibold d-block mb-1 lh-1">Deadline For Job Application</span>
                    {formattedDeadline}
                  </li>
                )}
                {salary && (
                  <li>
                    <span class="text-title fw-semibold d-block mb-1 lh-1">Salary Range</span>{salary}
                  </li>
                )}
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Career Info Section End -->

    <!-- Footer Section Start -->
    <Footer />
    <!-- Footer End -->

  </div>
</div>

</Layout>

