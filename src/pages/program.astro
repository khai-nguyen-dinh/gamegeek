---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
import { getContent, getContentObject } from '../utils/content.ts';
import { load } from 'js-yaml';

// Helper function to parse frontmatter
function parseFrontmatter(content: string) {
  const frontmatterRegex = /^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/;
  const match = content.match(frontmatterRegex);
  
  if (!match) {
    return { data: {}, content: content.trim() };
  }
  
  const yamlContent = match[1];
  const bodyContent = match[2];
  
  try {
    const data = load(yamlContent) as any;
    return { data: data || {}, content: bodyContent.trim() };
  } catch (error) {
    return { data: {}, content: bodyContent.trim() };
  }
}

// Helper to get GitHub token from environment (for Cloudflare)
function getGitHubToken(): string | null {
  // In Astro pages, try to get from locals (Cloudflare runtime)
  try {
    // @ts-ignore - Astro locals may have runtime
    const runtime = (Astro.locals as any)?.runtime;
    // @ts-ignore
    const env = runtime?.env || {};
    if (env.GITHUB_TOKEN || env.KEYSTATIC_GITHUB_TOKEN) {
      return env.GITHUB_TOKEN || env.KEYSTATIC_GITHUB_TOKEN;
    }
  } catch (e) {
    // Ignore
  }
  
  // Fallback to import.meta.env (set in Cloudflare environment variables)
  return import.meta.env.GITHUB_TOKEN || import.meta.env.KEYSTATIC_GITHUB_TOKEN || null;
}

// Helper function to fetch file from GitHub
async function fetchFromGitHub(path: string): Promise<string | null> {
  try {
    const repo = 'khai-nguyen-dinh/gamegeek';
    const branch = 'main';
    const url = `https://raw.githubusercontent.com/${repo}/${branch}/${path}`;
    
    const headers: HeadersInit = {
      'Accept': 'application/vnd.github.v3+raw',
      'User-Agent': 'GameGeek-CMS',
    };
    
    const token = getGitHubToken();
    if (token) {
      headers['Authorization'] = `token ${token}`;
    }
    
    const response = await fetch(url, { headers });
    if (response.ok) {
      return await response.text();
    }
    
    if (response.status === 403) {
      console.error(`GitHub API rate limit or forbidden for ${path}`);
    }
    
    return null;
  } catch (error) {
    console.error(`Error fetching from GitHub: ${path}`, error);
    return null;
  }
}

// Helper function to list files in a GitHub directory
async function listGitHubFiles(path: string): Promise<string[]> {
  try {
    const repo = 'khai-nguyen-dinh/gamegeek';
    const branch = 'main';
    const url = `https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`;
    
    const headers: HeadersInit = {
      'Accept': 'application/vnd.github.v3+json',
      'User-Agent': 'GameGeek-CMS',
    };
    
    const token = getGitHubToken();
    if (token) {
      headers['Authorization'] = `token ${token}`;
    }
    
    const response = await fetch(url, { headers });
    
    if (!response.ok) {
      if (response.status === 403) {
        const errorData = await response.json().catch(() => ({}));
        if (errorData.message?.includes('rate limit')) {
          console.error(`GitHub API rate limit exceeded for ${path}. Please add GITHUB_TOKEN to environment variables.`);
        } else {
          console.error(`GitHub API forbidden for ${path}:`, errorData.message || response.statusText);
        }
      } else if (response.status === 404) {
        console.error(`Directory not found: ${path}`);
      } else {
        console.error(`GitHub API error for ${path}: ${response.status} ${response.statusText}`);
      }
      return [];
    }
    
    const files = await response.json();
    if (Array.isArray(files)) {
      const fileNames = files.filter((file: any) => file.type === 'file').map((file: any) => file.name);
      return fileNames;
    }
    
    console.warn(`Unexpected response format for ${path}:`, typeof files);
    return [];
  } catch (error) {
    console.error(`Error listing GitHub files: ${path}`, error);
    return [];
  }
}

// Helper function to read mdoc file (only from GitHub API)
async function readMdocFile(slug: string) {
  if (!slug) return null;
  
  const fileContent = await fetchFromGitHub(`src/keystatic/events/${slug}.mdoc`);
  
  if (!fileContent) return null;
  
  const { data, content: fileContentBody } = parseFrontmatter(fileContent);
  
  // Ensure we have valid data
  if (!data || Object.keys(data).length === 0) {
    return null;
  }
  
  return {
    ...data,
    description: fileContentBody || '',
    content: fileContentBody || '',
    slug: slug
  };
}

// Helper function to get all events (GitHub API only)
async function getAllEvents() {
  try {
    const files = await listGitHubFiles('src/keystatic/events');
    const mdocFiles = files.filter(f => f.endsWith('.mdoc'));
    
    if (mdocFiles.length === 0) {
      return [];
    }
    
    const events = await Promise.all(
      mdocFiles.map(async (file) => {
        try {
          const slug = file.replace('.mdoc', '');
          const event = await readMdocFile(slug);
          if (event) {
            event.slug = slug;
          }
          return event;
        } catch (err) {
          return null;
        }
      })
    );
    
    return events.filter(e => e !== null);
  } catch (error) {
    return [];
  }
}

// Get all events from GitHub
const allEvents = await getAllEvents();

// Get program content
const programContent = getContentObject('program');
const heroContent = programContent?.hero || {};
const upcomingEvents = programContent?.upcomingEvents || {};
const filters = programContent?.filters || {};
const eventStatus = programContent?.eventStatus || {};

// Sort events by date (newest first)
const sortedEvents = allEvents.sort((a, b) => {
  const dateA = a.date ? new Date(a.date).getTime() : 0;
  const dateB = b.date ? new Date(b.date).getTime() : 0;
  return dateB - dateA;
});

// Get hero events (events đại diện) - lấy tất cả events có isHero = true
const heroEvents = sortedEvents.filter(e => e.isHero === true);
// Nếu không có hero events, lấy các featured events hoặc 3 events đầu tiên
const finalHeroEvents = heroEvents.length > 0 
  ? heroEvents 
  : (sortedEvents.filter(e => e.featured).length > 0 
      ? sortedEvents.filter(e => e.featured).slice(0, 3)
      : sortedEvents.slice(0, 3));

// Get all events for display (excluding hero events, sorted from newest to oldest)
// If no hero events, show all events; otherwise exclude hero events
const displayEvents = heroEvents.length > 0 
  ? sortedEvents.filter(e => !e.isHero)
  : sortedEvents;

// Helper to format date
function formatDate(date: any): string {
  if (!date) return '';
  if (typeof date === 'string') return date;
  if (date instanceof Date) {
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  }
  return String(date);
}

// Helper to get year from date
function getYear(date: any): string {
  if (!date) return '';
  if (typeof date === 'string') {
    const parsed = new Date(date);
    return parsed.getFullYear().toString();
  }
  if (date instanceof Date) {
    return date.getFullYear().toString();
  }
  return '';
}

// Helper to check if event is upcoming
function isUpcoming(date: any): boolean {
  if (!date) return false;
  const eventDate = date instanceof Date ? date : new Date(date);
  return eventDate >= new Date();
}
---

<Layout title="GameGeek | Connecting the Game Industry of Vietnam">

    <div id="smooth-wrapper">
        <div id="smooth-content">

            <Navbar variant="white" />

            <!-- Featured Programs Section Title -->
            <div class="hero-area style-two position-relative z-1 overflow-hidden">
                <div class="row text-center">
                            <div class="section-heading text-center pb-20">
                                <h2 class="section-title style-one text-title fw-bold">{heroContent.title || 'OUR FEATURED PROGRAMS'}</h2>
                            </div>
                </div>
                <div class="br-one position-absolute top-0 z-n1"></div>
                <div class="br-two position-absolute top-0 z-n1"></div>
                <div class="br-three position-absolute top-0 z-n1"></div>
                <div class="container">
                    
                    {finalHeroEvents.length > 0 ? (
                        <div class="hero-slider-one swiper swiper-fade swiper-initialized swiper-horizontal swiper-autoheight swiper-watch-progress swiper-backface-hidden"
                            data-cue="slideInUp" data-show="true"
                            style="animation-name: slideInUp; animation-duration: 600ms; animation-timing-function: ease; animation-delay: 0ms; animation-direction: normal; animation-fill-mode: both;">
                            <div class="swiper-wrapper" style="height: 732px;" id="swiper-wrapper-43c94ed6e5119c65"
                                aria-live="polite">
                                {finalHeroEvents.map((event, index) => {
                                    const slideClass = index === 0 ? 'swiper-slide swiper-slide-visible swiper-slide-fully-visible swiper-slide-active' : index === 1 ? 'swiper-slide swiper-slide-next' : 'swiper-slide';
                                    const slideStyle = `width: 1475px; opacity: ${index === 0 ? '1' : '0'}; transform: translate3d(${index * -1475}px, 0px, 0px);`;
                                    const bgClass = `bg-${(index % 3) + 1}`;
                                    const bgStyle = event.image ? `background-image: url('${event.image}'); background-size: cover; background-position: center;` : '';
                                    
                                    return (
                                        <div class={slideClass}
                                            style={slideStyle} role="group"
                                            aria-label={`${index + 1} / ${finalHeroEvents.length}`} data-swiper-slide-index={index}>
                                            <div
                                                class={`hero-slide-item ${bgClass} bg-f d-flex flex-column justify-content-end position-relative overflow-hidden z-1 round-30`}
                                                style={bgStyle}>
                                                <div class="hero-slide-title text-center mb-40">
                                                    <h2 class="fs-32 fw-bold text-white">{event.title || 'Event'}</h2>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                            <div
                                class="hero-pagination swiper-pagination-clickable swiper-pagination-bullets swiper-pagination-horizontal">
                                {finalHeroEvents.map((event, index) => (
                                    <span class={`swiper-pagination-bullet ${index === 0 ? 'swiper-pagination-bullet-active' : ''}`} tabindex="0"
                                        aria-current={index === 0 ? 'true' : undefined}
                                        title={event.title || `Event ${index + 1}`}>{String(index + 1).padStart(2, '0')}</span>
                                ))}
                            </div>
                            <span class="swiper-notification" aria-live="assertive" aria-atomic="true"></span>
                        </div>
                    ) : (
                        <div class="text-center py-5">
                            <h2 class="fs-32 fw-bold text-title">No featured events available</h2>
                        </div>
                    )}
                </div>
                <div class="post-share d-flex flex-wrap align-items-center justify-content-md-end">
                    <span class="text-title fw-semibold">{programContent.followText || 'Follow Us:'}</span>
                    <ul class="social-profile style-three list-unstyled mb-0">
                        <li><a href="https://www.facebook.com/" target="_blank"
                                class="d-flex flex-column align-items-center justify-content-center rounded-circle"><i
                                    class="ri-facebook-fill"></i></a></li>
                        <li><a href="https://x.com/?lang=en" target="_blank"
                                class="d-flex flex-column align-items-center justify-content-center rounded-circle"><i
                                    class="ri-twitter-x-line"></i></a></li>
                        <li><a href="https://www.instagram.com/" target="_blank"
                                class="d-flex flex-column align-items-center justify-content-center rounded-circle"><i
                                    class="ri-instagram-line"></i></a></li>
                        <li><a href="https://www.linkedin.com/" target="_blank"
                                class="d-flex flex-column align-items-center justify-content-center rounded-circle"><i
                                    class="ri-linkedin-fill"></i></a></li>
                    </ul>
                </div>
            </div>

            <!-- Upcoming Events Section -->
            <div class="container pt-60 pb-120">
                <div class="section-heading text-center pb-20">
                    <h2 class="section-title style-one text-title fw-bold">{upcomingEvents.title || 'UPCOMING EVENTS'}</h2>
                </div>
                <div class="project-filter-box style-one d-flex flex-wrap align-items-end round-10 mb-40">
                    <div class="form-group mb-20">
                        <label class="fs-14 fw-semibold text-title d-block mb-1">{filters.eventStatus?.label || 'Event Status'}</label>
                        <select class="w-100 ht-48 border-0 bg-gray outline-0">
                            {(filters.eventStatus?.options || ['All', 'Upcoming', 'Past']).map((option, index) => (
                              <option value={index}>{option}</option>
                            ))}
                        </select>
                    </div>
                    <div class="form-group mb-20">
                        <label class="fs-14 fw-semibold text-title d-block mb-1">{filters.location?.label || 'Location'}</label>
                        <select class="w-100 ht-48 border-0 bg-gray outline-0">
                            {(filters.location?.options || ['All City', 'Ha Noi', 'Ho Chi Minh City']).map((option, index) => (
                              <option value={index}>{option}</option>
                            ))}
                        </select>
                    </div>
                    <div class="form-group mb-20">
                        <label class="fs-14 fw-semibold text-title d-block mb-1">{filters.year?.label || 'Year of Event'}</label>
                        <select class="w-100 ht-48 border-0 bg-gray outline-0">
                            {(filters.year?.options || ['All Year', '2023', '2024', '2025', '2026', '2027', '2028', '2029', '2030']).map((option, index) => (
                              <option value={index}>{option}</option>
                            ))}
                        </select>
                    </div>
                    <div class="form-group mb-20">
                        <button class="btn style-two d-block w-100 p-0"><span class="btn-text d-block w-100 fw-semibold position-relative transition">{filters.searchButton || 'Search Projects'}</span></button>
                    </div>
                </div>
                <div class="row justify-content-center">
                    {displayEvents.length > 0 ? (
                        displayEvents.map((event, index) => {
                            const bgClass = `bg-${(index % 4) + 1}`;
                            const eventYear = getYear(event.date);
                            const status = isUpcoming(event.date) ? (eventStatus.upcoming || 'Upcoming') : (eventStatus.completed || 'Completed');
                            const imageUrl = event.image || `/renius/image/project-bg-${(index % 4) + 5}.jpg`;
                            const description = event.description || '';
                            const shortDescription = description.length > 120 ? `${description.slice(0, 117)}...` : description;
                            
                            return (
                                <div class="col-xl-4 col-md-6">
                                    <div class={`project-card style-four ${bgClass} position-relative overflow-hidden z-1 round-10 mb-45`} style="min-height: 420px; box-shadow: none !important;">
                                        <img src={imageUrl} alt={event.title || 'Event'} class="position-absolute top-0 start-0 w-100 h-100" style="object-fit: cover; box-shadow: none !important; filter: none !important; z-index: 1;">
                                        <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(180deg, rgba(0,0,0,0.55) 0%, rgba(0,0,0,0.85) 100%); z-index: 2;"></div>
                                        <div class="project-header position-absolute top-0 start-0 w-100 d-flex flex-wrap align-items-center justify-content-between" style="padding: 8px 12px; z-index: 3;">
                                            <span class="project-status transition text-white bg-primary px-3 py-1 rounded-2 fw-semibold" style="font-size: 15px; text-shadow: 0 2px 6px rgba(0,0,0,0.6);">{status}</span>
                                            <span class="project-counter transition text-white fw-semibold" style="font-size: 15px; text-shadow: 0 2px 6px rgba(0,0,0,0.6);">{eventYear}</span>
                                        </div>
                                        <div class="project-title position-absolute bottom-0 start-0 w-100 d-flex flex-wrap align-items-center justify-content-between" style="padding: 20px; z-index: 3;">
                                            <h3 class="fs-24 fw-semibold mb-0 text-white" style="text-shadow: 0 2px 6px rgba(0,0,0,0.6);">
                                                <a href={`/event-detail/${event.slug}`} class="text-white hover-text-primary transition" style="text-shadow: 0 2px 6px rgba(0,0,0,0.6);">{event.title || 'Event'}</a>
                                            </h3>
                                        </div>
                                    </div>
                                </div>
                            );
                        })
                    ) : (
                        <div class="col-12 text-center">
                            <p class="text-para">No events available at the moment.</p>
                        </div>
                    )}
                </div>
                 <ul class="page-nav pagination justify-content-center mb-0 mt-lg-4">
                    <li class="page-item">
                        <a class="page-link d-flex flex-column align-items-center justify-content-center rounded-circle" href="/program" aria-label="Previous">
                            <img src="/renius/image/left-long-arrow-gray.svg" alt="Icon">
                        </a>
                    </li>
                    <li class="page-item"><a class="page-link d-flex flex-column align-items-center justify-content-center rounded-circle active" href="/program">01</a></li>
                    <li class="page-item"><a class="page-link d-flex flex-column align-items-center justify-content-center rounded-circle" href="/program">02</a></li>
                    <li class="page-item"><a class="page-link d-flex flex-column align-items-center justify-content-center rounded-circle" href="/program">03</a></li>
                    <li class="page-item">
                        <a class="page-link d-flex flex-column align-items-center justify-content-center rounded-circle" href="/program" aria-label="Next">
                            <img src="/renius/image/right-long-arrow-gray.svg" alt="Icon">
                        </a>
                    </li>
                </ul>
            </div>
           
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    const aboutServiceSlider = new Swiper('.about-area .service-slider', {
                        slidesPerView: 1,
                        spaceBetween: 30,
                        loop: true,
                        autoplay: {
                            delay: 3000,
                            disableOnInteraction: false,
                        },
                        pagination: {
                            el: '.about-area .swiper-pagination',
                            clickable: true,
                        },
                        breakpoints: {
                            768: {
                                slidesPerView: 2,
                                spaceBetween: 30,
                            },
                            1024: {
                                slidesPerView: 3,
                                spaceBetween: 30,
                            },
                        },
                    });
                });
            </script>


            <!-- Footer Section Start -->
            <Footer />
            <!-- Footer End -->

        </div>
    </div>

    <!-- Back to Top -->
    <div id="progress-wrap" class="progress-wrap style-one">
        <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
            <path id="progress-path" d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98" />
        </svg>
    </div>

    <script>
        // Navbar scroll behavior
        document.addEventListener('DOMContentLoaded', function () {
            const navbar = document.getElementById('navbar');

            function handleScroll() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

                if (scrollTop > 100) {
                    // When scrolled, show compact menu
                    navbar.classList.add('navbar-compact');
                } else {
                    // When at top, show full header
                    navbar.classList.remove('navbar-compact');
                }
            }

            // Initial check for scroll position
            handleScroll();

            // Add scroll event listener
            window.addEventListener('scroll', handleScroll, { passive: true });
        });

        // Counter Animation
        document.addEventListener('DOMContentLoaded', function () {
            const counterNumbers = document.querySelectorAll('.feature-area.style-three .counter-number');
            let hasAnimated = false;

            // Function to animate counter
            function animateCounter(element, target, duration = 2000) {
                const start = 0;
                const increment = target / (duration / 16); // 60fps
                let current = start;

                const timer = setInterval(() => {
                    current += increment;
                    if (current >= target) {
                        current = target;
                        clearInterval(timer);
                    }
                    element.textContent = Math.floor(current);
                }, 16);
            }

            // Intersection Observer to trigger animation when section is visible
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && !hasAnimated) {
                        hasAnimated = true;

                        counterNumbers.forEach((counter, index) => {
                            const target = parseInt(counter.getAttribute('data-target'));
                            if (target) {
                                // Add delay for each counter
                                setTimeout(() => {
                                    animateCounter(counter, target);
                                }, index * 200);
                            }
                        });
                    }
                });
            }, {
                threshold: 0.3 // Trigger when 30% of section is visible
            });

            const counterSection = document.querySelector('.feature-area.style-three');
            if (counterSection) {
                observer.observe(counterSection);
            }
        });
    </script>
</Layout>