---
import Layout from '../../layouts/Layout.astro';

// Default test JSON file path
const defaultFilePath = 'src/data/test.json';
const repo = 'khai-nguyen-dinh/gamegeek';
const branch = 'main';
---

<Layout title="Test JSON Editor">
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="card shadow">
          <div class="card-header bg-primary text-white">
            <h2 class="mb-0">JSON File Editor & GitHub Push</h2>
            <small>Edit JSON file and push to GitHub</small>
          </div>
          <div class="card-body">
            <form id="jsonEditorForm">
              <div class="mb-3">
                <label for="filePath" class="form-label">File Path (relative to repo root)</label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="filePath" 
                  name="filePath" 
                  value={defaultFilePath}
                  placeholder="src/data/test.json"
                />
                <small class="form-text text-muted">Example: src/data/test.json</small>
              </div>

              <div class="mb-3">
                <label for="jsonContent" class="form-label">JSON Content</label>
                <textarea 
                  class="form-control font-monospace" 
                  id="jsonContent" 
                  name="jsonContent" 
                  rows="15"
                  placeholder='{"test": "data", "example": true}'
                ></textarea>
                <small class="form-text text-muted">Enter valid JSON content</small>
              </div>

              <div class="mb-3">
                <label for="commitMessage" class="form-label">Commit Message</label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="commitMessage" 
                  name="commitMessage" 
                  value="Update JSON file via CMS"
                  placeholder="Commit message"
                />
              </div>

              <div class="d-flex gap-2">
                <button type="button" class="btn btn-info" id="loadLocalBtn">
                  Load from Local
                </button>
                <button type="button" class="btn btn-secondary" id="loadGitHubBtn">
                  Load from GitHub
                </button>
                <button type="submit" class="btn btn-primary" id="saveBtn">
                  Save & Push to GitHub
                </button>
              </div>
            </form>

            <div id="statusMessage" class="mt-3"></div>
          </div>
        </div>

        <div class="card mt-4">
          <div class="card-header">
            <h5 class="mb-0">Instructions</h5>
          </div>
          <div class="card-body">
            <ol>
              <li>Enter the file path (relative to repository root, e.g., <code>src/data/test.json</code>)</li>
              <li>Click <strong>"Load from Local"</strong> to load from local filesystem (if file exists)</li>
              <li>Or click <strong>"Load from GitHub"</strong> to load from GitHub repository</li>
              <li>Edit the JSON content in the textarea</li>
              <li>Enter a commit message</li>
              <li>Click <strong>"Save & Push to GitHub"</strong> to commit and push to GitHub</li>
            </ol>
            <div class="alert alert-info mt-3">
              <strong>Workflow:</strong> Local files → Edit in CMS → Push to GitHub → Deploy
            </div>
            <div class="alert alert-info mt-3">
              <strong>Authentication:</strong> 
              <ul class="mb-0 mt-2">
                <li>If you're logged in via <strong>Keystatic OAuth</strong> (visit <code>/keystatic</code> first), 
                    the token will be used automatically from your session.</li>
                <li>Or set <code>GITHUB_TOKEN</code> or <code>KEYSTATIC_GITHUB_TOKEN</code> environment variable 
                    with a GitHub Personal Access Token that has <code>repo</code> scope.</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById('jsonEditorForm') as HTMLFormElement;
    const filePathInput = document.getElementById('filePath') as HTMLInputElement;
    const jsonContentTextarea = document.getElementById('jsonContent') as HTMLTextAreaElement;
    const commitMessageInput = document.getElementById('commitMessage') as HTMLInputElement;
    const loadLocalBtn = document.getElementById('loadLocalBtn') as HTMLButtonElement;
    const loadGitHubBtn = document.getElementById('loadGitHubBtn') as HTMLButtonElement;
    const saveBtn = document.getElementById('saveBtn') as HTMLButtonElement;
    const statusMessage = document.getElementById('statusMessage') as HTMLDivElement;

    function showStatus(message: string, type: 'success' | 'error' | 'info' = 'info') {
      statusMessage.innerHTML = `
        <div class="alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
    }

    // Load file from Local filesystem
    loadLocalBtn.addEventListener('click', async () => {
      const filePath = filePathInput.value.trim();
      if (!filePath) {
        showStatus('Please enter a file path', 'error');
        return;
      }

      loadLocalBtn.disabled = true;
      loadLocalBtn.textContent = 'Loading...';
      showStatus('Loading file from local filesystem...', 'info');

      try {
        const response = await fetch(`/api/local/read?path=${encodeURIComponent(filePath)}`);
        const data = await response.json();

        if (data.success) {
          // Format JSON with indentation
          const formatted = JSON.stringify(JSON.parse(data.content), null, 2);
          jsonContentTextarea.value = formatted;
          showStatus('File loaded from local filesystem!', 'success');
        } else {
          showStatus(`Error: ${data.error}`, 'error');
        }
      } catch (error: any) {
        showStatus(`Error loading file: ${error.message}`, 'error');
      } finally {
        loadLocalBtn.disabled = false;
        loadLocalBtn.textContent = 'Load from Local';
      }
    });

    // Load file from GitHub
    loadGitHubBtn.addEventListener('click', async () => {
      const filePath = filePathInput.value.trim();
      if (!filePath) {
        showStatus('Please enter a file path', 'error');
        return;
      }

      loadGitHubBtn.disabled = true;
      loadGitHubBtn.textContent = 'Loading...';
      showStatus('Loading file from GitHub...', 'info');

      try {
        const response = await fetch(`/api/github/read?path=${encodeURIComponent(filePath)}`);
        const data = await response.json();

        if (data.success) {
          // Format JSON with indentation
          const formatted = JSON.stringify(JSON.parse(data.content), null, 2);
          jsonContentTextarea.value = formatted;
          showStatus('File loaded from GitHub!', 'success');
        } else {
          showStatus(`Error: ${data.error}`, 'error');
        }
      } catch (error: any) {
        showStatus(`Error loading file: ${error.message}`, 'error');
      } finally {
        loadGitHubBtn.disabled = false;
        loadGitHubBtn.textContent = 'Load from GitHub';
      }
    });

    // Save and push to GitHub
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const filePath = filePathInput.value.trim();
      const jsonContent = jsonContentTextarea.value.trim();
      const commitMessage = commitMessageInput.value.trim() || 'Update JSON file via CMS';

      if (!filePath) {
        showStatus('Please enter a file path', 'error');
        return;
      }

      if (!jsonContent) {
        showStatus('Please enter JSON content', 'error');
        return;
      }

      // Validate JSON
      try {
        JSON.parse(jsonContent);
      } catch (error) {
        showStatus('Invalid JSON format. Please check your JSON syntax.', 'error');
        return;
      }

      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';
      showStatus('Saving and pushing to GitHub...', 'info');

      try {
        // Try to get token from localStorage (if user logged in via Keystatic)
        const tokenFromStorage = localStorage.getItem('keystatic-gh-access-token');
        
        const headers: Record<string, string> = {
          'Content-Type': 'application/json',
        };
        
        // Add token to header if available (for server-side cookie fallback)
        if (tokenFromStorage) {
          headers['X-GitHub-Token'] = tokenFromStorage;
        }
        
        const response = await fetch('/api/github/push', {
          method: 'POST',
          headers,
          body: JSON.stringify({
            path: filePath,
            content: jsonContent,
            message: commitMessage,
          }),
        });

        const data = await response.json();

        if (data.success) {
          showStatus(`Success! File pushed to GitHub. Commit: ${data.commitSha}`, 'success');
        } else {
          showStatus(`Error: ${data.error}`, 'error');
        }
      } catch (error: any) {
        showStatus(`Error saving file: ${error.message}`, 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save & Push to GitHub';
      }
    });
  </script>
</Layout>

