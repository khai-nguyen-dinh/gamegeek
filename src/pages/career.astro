---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
import { load } from 'js-yaml';
import { getContentObject } from '../utils/content.ts';

function parseFrontmatter(content: string) {
  const frontmatterRegex = /^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/;
  let match = content.match(frontmatterRegex);
  
  if (!match) {
    const firstDash = content.indexOf('---\n');
    if (firstDash === 0) {
      const secondDash = content.indexOf('\n---\n', firstDash + 4);
      if (secondDash > 0) {
        const yamlContent = content.substring(4, secondDash);
        const bodyContent = content.substring(secondDash + 5);
        try {
          const data = load(yamlContent) as any;
          return { data: data || {}, content: bodyContent.trim() };
        } catch (error) {
          console.error('Error parsing YAML:', error);
          return { data: {}, content: bodyContent.trim() };
        }
      }
    }
    return { data: {}, content: content.trim() };
  }

  const yamlContent = match[1];
  const bodyContent = match[2];

  try {
    const data = load(yamlContent) as any;
    return { data: data || {}, content: bodyContent.trim() };
  } catch (error) {
    console.error('Error parsing YAML:', error);
    return { data: {}, content: bodyContent.trim() };
  }
}

// Helper to get GitHub token from environment
function getGitHubToken(): string | null {
  try {
    const runtime = (Astro.locals as any)?.runtime;
    const env = runtime?.env || {};
    if (env.GITHUB_TOKEN || env.KEYSTATIC_GITHUB_TOKEN) {
      return env.GITHUB_TOKEN || env.KEYSTATIC_GITHUB_TOKEN;
    }
  } catch (e) {
    // Ignore
  }
  
  return import.meta.env.GITHUB_TOKEN || import.meta.env.KEYSTATIC_GITHUB_TOKEN || null;
}

// Fetch raw file from GitHub
async function fetchFromGitHub(path: string): Promise<string | null> {
  try {
    const repo = 'khai-nguyen-dinh/gamegeek';
    const branch = 'main';
    const url = `https://raw.githubusercontent.com/${repo}/${branch}/${path}`;
    
    const headers: HeadersInit = {
      'Accept': 'application/vnd.github.v3+raw',
      'User-Agent': 'GameGeek-CMS',
    };
    
    const token = getGitHubToken();
    if (token) {
      headers['Authorization'] = `token ${token}`;
    }
    
    const response = await fetch(url, { headers });
    if (response.ok) {
      return await response.text();
    }
    
    return null;
  } catch (error) {
    console.error(`Error fetching from GitHub: ${path}`, error);
    return null;
  }
}

// List files in a GitHub directory
async function listGitHubFiles(path: string): Promise<string[]> {
  try {
    const repo = 'khai-nguyen-dinh/gamegeek';
    const branch = 'main';
    const url = `https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`;
    
    const headers: HeadersInit = {
      'Accept': 'application/vnd.github.v3+json',
      'User-Agent': 'GameGeek-CMS',
    };
    
    const token = getGitHubToken();
    if (token) {
      headers['Authorization'] = `token ${token}`;
    }
    
    const response = await fetch(url, { headers });
    if (response.ok) {
      const files = await response.json();
      if (Array.isArray(files)) {
        return files.map((file: any) => file.name).filter((name: string) => name.endsWith('.mdoc'));
      }
    }
    
    return [];
  } catch (error) {
    console.error(`Error listing GitHub files: ${path}`, error);
    return [];
  }
}

// Read a single career mdoc by slug
async function readCareerFile(slug: string) {
  if (!slug) return null;
  const fileContent = await fetchFromGitHub(`src/keystatic/careers/${slug}.mdoc`);
  if (!fileContent) return null;

  const { data, content: fileContentBody } = parseFrontmatter(fileContent);
  if (!data || Object.keys(data).length === 0) return null;

  return {
    ...data,
    content: fileContentBody || '',
    slug,
  };
}

// Get all careers from GitHub API (works in both dev and production)
async function getAllCareers() {
  try {
    const files = await listGitHubFiles('src/keystatic/careers');
    const mdocFiles = files.filter(f => f.endsWith('.mdoc'));
    
    if (mdocFiles.length === 0) {
      return [];
    }
    
    const careers = await Promise.all(
      mdocFiles.map(async (file) => {
        try {
          const slug = file.replace('.mdoc', '');
          const content = await fetchFromGitHub(`src/keystatic/careers/${file}`);
          
          if (!content) return null;
          
          const { data, content: fileContentBody } = parseFrontmatter(content);
          if (!data || Object.keys(data).length === 0) return null;
          
          // Only return active careers
          if (data.active === false) return null;
          
          return {
            ...data,
            content: fileContentBody || '',
            slug,
          };
        } catch (err) {
          console.warn(`Error processing career file ${file}:`, err);
          return null;
        }
      })
    );
    
    return careers.filter(c => c !== null && c !== undefined);
  } catch (error) {
    console.error('Error fetching careers from GitHub:', error);
    return [];
  }
}

// Load content and careers with error handling
let careerContent: any = {};
let breadcrumb: any = {};
let jobMeta: any = {};
let allCareers: any[] = [];

try {
  const content = getContentObject('career');
  if (content) {
    careerContent = content;
    breadcrumb = content.breadcrumb || {};
    jobMeta = content.jobMeta || {};
  }
} catch (error) {
  console.error('Error loading career content:', error);
  // Set defaults
  jobMeta = { location: 'Location:', type: 'Type:', experience: 'Experience:' };
}

// Ensure all values are strings
const breadcrumbTitle = String(breadcrumb?.title || 'CAREERS');
const breadcrumbHome = String(breadcrumb?.home || 'HOME');
const breadcrumbCurrent = String(breadcrumb?.current || 'CAREERS');
const jobMetaLocation = String(jobMeta?.location || 'Location:');
const jobMetaType = String(jobMeta?.type || 'Type:');
const jobMetaExperience = String(jobMeta?.experience || 'Experience:');
const applyButtonText = String(careerContent?.applyButton || 'Apply Now');

try {
  allCareers = await getAllCareers();
  if (!Array.isArray(allCareers)) {
    allCareers = [];
  }
} catch (error) {
  console.error('Error loading careers:', error);
  allCareers = [];
}
---

<Layout title="About Us | GameGeek">

  <div id="smooth-wrapper">
    <div id="smooth-content">

      <Navbar variant="white" />
      <div class="breadcrumb-area position-relative z-1">
        <img
          src="/renius/image/br-line-shape.png"
          alt="Shape"
          class="br-line-shape position-absolute top-0 start-0 w-100 h-100 z-n1"
        />
        <img
          src="/renius/image/br-shape-1.png"
          alt="Shape"
          class="br-shape-one position-absolute z-n1 bounce"
        />
        <img
          src="/renius/image/br-shape-2.png"
          alt="Shape"
          class="br-shape-two position-absolute bottom-0 z-n1 moveHorizontal"
        />
        <div class="container-fluid px-xxl-5">
          <div class="row">
            <div class="col-md-10 offset-md-1 text-center">
              <h2 class="section-title style-one fw-black text-title">
                {breadcrumbTitle}
              </h2>
              <ul class="br-menu list-unstyled">
                <li>
                  <a href="/">
                    <img src="/renius/image/home-icon.svg" alt="Icon" />
                    {breadcrumbHome}
                  </a>
                </li>
                <li>{breadcrumbCurrent}</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="container ptb-120">
        {allCareers.length > 0 && (
          <div class="row justify-content-center">
            {allCareers.map((career) => {
              if (!career || !career.slug || !career.title) {
                return null;
              }
              const careerSlug = String(career.slug);
              const careerTitle = String(career.title);
              const careerLocation = String(career.location || "");
              const careerType = String(career.type || "");
              const careerExperience = String(career.experience || "");
              const careerUrl = "/career/" + careerSlug;
              return (
                <div class="col-xl-4 col-md-6">
                  <div class="job-card style-one position-relative z-1 round-10 mb-30">
                    <div class="job-info">
                      <h3 class="fs-24 fw-bold">
                        <a
                          href={careerUrl}
                          class="text-title link-hover-primary transition"
                        >
                          {careerTitle}
                        </a>
                      </h3>
                      <ul class="job-metainfo list-unstyled">
                        <li class="position-relative">
                          <i class="ri-map-pin-line"></i>
                          <span class="fw-medium text-title me-1">
                            {jobMetaLocation}
                          </span>{" "}
                          {careerLocation}
                        </li>
                        <li class="position-relative">
                          <i class="ri-briefcase-line"></i>
                          <span class="fw-medium text-title me-1">
                            {jobMetaType}
                          </span>{" "}
                          {careerType}
                        </li>
                        <li class="position-relative">
                          <i class="ri-user-line"></i>
                          <span class="fw-medium text-title me-1">
                            {jobMetaExperience}
                          </span>{" "}
                          {careerExperience}
                        </li>
                      </ul>
                      <div class="text-center">
                        <a href={careerUrl} class="link style-one fw-semibold">
                          {applyButtonText}{" "}
                          <img
                            src="/renius/image/right-arrow-small.svg"
                            alt="Icon"
                          />
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        )}
        {allCareers.length === 0 && (
          <div class="row justify-content-center">
            <div class="col-12 text-center">
              <p class="text-muted">
                No job openings available at the moment. Please check back
                later.
              </p>
            </div>
          </div>
        )}
        {allCareers.length > 0 && (
          <ul class="page-nav pagination justify-content-center mb-0 mt-lg-5">
            <li class="page-item">
              <a
                class="page-link d-flex flex-column align-items-center justify-content-center rounded-circle"
                href="#"
                aria-label="Previous"
              >
                <i class="ri-arrow-left-line"></i>
              </a>
            </li>
            <li class="page-item">
              <a
                class="page-link d-flex flex-column align-items-center justify-content-center rounded-circle active"
                href="#"
              >
                01
              </a>
            </li>
            <li class="page-item">
              <a
                class="page-link d-flex flex-column align-items-center justify-content-center rounded-circle"
                href="#"
              >
                02
              </a>
            </li>
            <li class="page-item">
              <a
                class="page-link d-flex flex-column align-items-center justify-content-center rounded-circle"
                href="#"
              >
                03
              </a>
            </li>
            <li class="page-item">
              <a
                class="page-link d-flex flex-column align-items-center justify-content-center rounded-circle"
                href="#"
                aria-label="Next"
              >
                <i class="ri-arrow-right-line"></i>
              </a>
            </li>
          </ul>
        )}
      </div>
      <Footer />
      <!-- Footer End -->

    </div>
  </div>

  <!-- Back to Top -->
  <div id="progress-wrap" class="progress-wrap style-one">
    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
      <path id="progress-path" d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98" />
    </svg>
  </div>
</Layout>