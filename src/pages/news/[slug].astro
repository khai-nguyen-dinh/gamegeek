---
import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/Navbar.astro';
import Footer from '../../components/Footer.astro';
import { load } from 'js-yaml';

// Check if running in Node.js environment (build time) or Cloudflare (runtime)
const isNode = typeof process !== 'undefined' && process.versions?.node;
const isCloudflare = typeof globalThis !== 'undefined' && 'caches' in globalThis;

// Helper function to parse frontmatter
function parseFrontmatter(content: string) {
  const frontmatterRegex = /^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/;
  const match = content.match(frontmatterRegex);
  
  if (!match) {
    return { data: {}, content: content.trim() };
  }
  
  const yamlContent = match[1];
  const bodyContent = match[2];
  
  try {
    const data = load(yamlContent) as any;
    return { data: data || {}, content: bodyContent.trim() };
  } catch (error) {
    return { data: {}, content: bodyContent.trim() };
  }
}

// Helper function to fetch file from GitHub (for Cloudflare runtime)
async function fetchFromGitHub(path: string): Promise<string | null> {
  try {
    const repo = 'khai-nguyen-dinh/gamegeek';
    const branch = 'main';
    const url = `https://raw.githubusercontent.com/${repo}/${branch}/${path}`;
    const response = await fetch(url);
    if (response.ok) {
      return await response.text();
    }
    return null;
  } catch (error) {
    console.error(`Error fetching from GitHub: ${path}`, error);
    return null;
  }
}

// Helper function to read mdoc files (works in both Node.js and Cloudflare)
async function readMdocFile(slug: string) {
  if (!slug) return null;
  
  let fileContent: string | null = null;
  
  if (isNode) {
    // Node.js environment (build time)
    try {
      const { readFileSync } = await import('fs');
      const { join } = await import('path');
      const filePath = join(process.cwd(), 'src/keystatic/posts', `${slug}.mdoc`);
      fileContent = readFileSync(filePath, 'utf-8');
    } catch (error) {
      console.error(`Error reading file:`, error);
      return null;
    }
  } else {
    // Cloudflare runtime - fetch from GitHub
    fileContent = await fetchFromGitHub(`src/keystatic/posts/${slug}.mdoc`);
  }
  
  if (!fileContent) return null;
  
  const { data, content: fileContentBody } = parseFrontmatter(fileContent);
  
  // Ensure we have valid data
  if (!data || Object.keys(data).length === 0) {
    return null;
  }
  
  return {
    ...data,
    content: fileContentBody || '',
    slug: slug
  };
}

// Helper function to get all posts
async function getAllPosts() {
  // List of known post slugs (can be generated at build time or fetched)
  const knownSlugs = [
    'vietnam-has-topped-the-world-in-mobile-game-exports-momentum-peaks-at-vietnam-game-connect-2025',
    'future-of-web-development-2025',
    'building-scalable-react-applications',
    'cross-platform-flutter-development',
    'database-security-best-practices-2025',
    'modern-ui-ux-design-principles',
    'cyber-security-threats-and-solutions',
    'it-consultancy-strategic-approaches',
    'test-test'
  ];
  
  if (isNode) {
    // Node.js: read from filesystem
    try {
      const { readdirSync } = await import('fs');
      const { join } = await import('path');
      const postsDir = join(process.cwd(), 'src/keystatic/posts');
      const files = readdirSync(postsDir).filter(f => f.endsWith('.mdoc'));
      const posts = await Promise.all(
        files.map(async (file) => {
          const fileSlug = file.replace('.mdoc', '');
          const post = await readMdocFile(fileSlug);
          if (post) {
            post.slug = fileSlug;
          }
          return post;
        })
      );
      return posts.filter(p => p !== null);
    } catch (error) {
      console.error('Error reading posts directory:', error);
      return [];
    }
  } else {
    // Cloudflare: fetch from GitHub
    const posts = await Promise.all(
      knownSlugs.map(async (slug) => {
        const post = await readMdocFile(slug);
        if (post) {
          post.slug = slug;
        }
        return post;
      })
    );
    return posts.filter(p => p !== null);
  }
}

// Helper function to get all categories
async function getAllCategories() {
  const knownCategoryFiles = [
    'vietnam-game-scene',
    'it-services',
    'database-security',
    'it-consultancy',
    'app-development',
    'ui-ux-design',
    'cyber-security'
  ];
  
  if (isNode) {
    // Node.js: read from filesystem
    try {
      const { readdirSync } = await import('fs');
      const { join } = await import('path');
      const { readFileSync } = await import('fs');
      const categoriesDir = join(process.cwd(), 'src/keystatic/categories');
      const files = readdirSync(categoriesDir).filter(f => f.endsWith('.yaml'));
      const categories = files.map(file => {
        const filePath = join(categoriesDir, file);
        const content = readFileSync(filePath, 'utf-8');
        const data = load(content) as any;
        return {
          id: data.id,
          name: data.name,
          slug: file.replace('.yaml', '')
        };
      });
      return categories;
    } catch (error) {
      console.error('Error reading categories directory:', error);
      return [];
    }
  } else {
    // Cloudflare: fetch from GitHub
    const categories = await Promise.all(
      knownCategoryFiles.map(async (slug) => {
        const content = await fetchFromGitHub(`src/keystatic/categories/${slug}.yaml`);
        if (!content) return null;
        try {
          const data = load(content) as any;
          return {
            id: data.id,
            name: data.name,
            slug: slug
          };
        } catch (error) {
          return null;
        }
      })
    );
    return categories.filter(c => c !== null);
  }
}

// Get the slug from the URL params
export async function getStaticPaths() {
  const posts = await getAllPosts();
  const categories = await getAllCategories();
  
  // Map category IDs to category names
  const categoryMap = new Map(categories.map(cat => [cat.id, cat.name]));
  
  // Transform posts to include category name
  const transformedPosts = posts.map(post => {
    const categoryName = categoryMap.get(post.category) || post.category;
    return {
      ...post,
      category: categoryName
    };
  });

  return transformedPosts.map((post) => ({
    params: { slug: post.slug },
    props: post
  }));
}

const { slug } = Astro.params;

// Get current post data - use props if available, otherwise read from file
let postData = Astro.props;
if (!postData || !postData.title) {
  // Fallback: read directly from file
  if (slug) {
    postData = await readMdocFile(slug);
    if (postData) {
      // Ensure slug is set from filename
      postData.slug = slug;
    }
  }
}

// If still no data, return 404
if (!postData || !postData.title) {
  return Astro.redirect('/news', 404);
}

const { title, date, category, author, image, thumb, thumb2, thumb3, breadcrumbBg, content } = postData;

// Get all data for sidebar and related posts
const allPosts = await getAllPosts();
const categoriesData = await getAllCategories();
const categoryMap = new Map(categoriesData.map(cat => [cat.id, cat.name]));

// Transform posts
const posts = allPosts.map(post => ({
  ...post,
  category: categoryMap.get(post.category) || post.category
}));
const categories = categoriesData;

const getDateTime = (value) => {
  if (!value) return 0;
  // Handle Date object from Keystatic
  if (value instanceof Date) {
    return value.getTime();
  }
  // Handle string date
  if (typeof value === 'string') {
    const parsed = new Date(value);
    return Number.isNaN(parsed.getTime()) ? 0 : parsed.getTime();
  }
  return 0;
};

const recentPosts = posts
  .filter(post => post.slug !== slug)
  .sort((a, b) => getDateTime(b.date) - getDateTime(a.date))
  .slice(0, 3);

// Get related posts (same category, exclude current)
const relatedPosts = posts
  .filter(post => post.slug !== slug && post.category === category)
  .slice(0, 3);

// Count posts per category
const categoryCounts = new Map();
posts.forEach(post => {
  const catId = post.category;
  const count = categoryCounts.get(catId) || 0;
  categoryCounts.set(catId, count + 1);
});

// Extract day and month from date
const dateTime = getDateTime(date);
let displayDay = '';
let displayMonth = '';

if (dateTime) {
  const dateObj = date instanceof Date ? date : new Date(dateTime);
  displayDay = dateObj.getDate().toString().padStart(2, '0');
  displayMonth = dateObj.toLocaleString('en-US', { month: 'short' });
}
---

<Layout title={`${title} - GameGeek`}>
  <div id="smooth-content">
    <!-- Navbar Start -->
    <Navbar variant="white" />
    <!-- Navbar End -->

    <!-- Breadcrumb Section Start -->
    <div class="breadcrumb-area position-relative z-1">
      <img src="/renius/image/br-line-shape.png" alt="Shape" class="br-line-shape position-absolute top-0 start-0 w-100 h-100 z-n1">
      <img src="/renius/image/br-shape-1.png" alt="Shape" class="br-shape-one position-absolute z-n1 bounce">
      <img src="/renius/image/br-shape-2.png" alt="Shape" class="br-shape-two position-absolute bottom-0 z-n1 moveHorizontal">
      <div class="container-fluid px-xxl-5">
        <div class="row">
          <div class="col-md-10 offset-md-1 text-center">
            <h2 class="section-title style-one fw-black text-title">Blog Details</h2>
            <ul class="br-menu list-unstyled">
              <li><a href="/"><img src="/renius/image/home-icon.svg" alt="Icon">HOME</a></li>
              <li><a href="/news">BLOG</a></li>
              <li>BLOG DETAILS</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <!-- Breadcrumb Section End -->

    <!-- Blog Details Start -->
    <div class="container ptb-120">
      <div class="row">
        <div class="col-xl-4 order-xl-1 order-2">
          <aside class="sidebar mt-lg-50">
            <div class="sidebar-widget search-widget bg-gray round-10">
              <form action="#" class="position-relative">
                <input type="search" placeholder="Search" class="w-100 bg-white border-0 round-10 text-para outline-0">
                <button class="position-absolute top-0 h-100 bg-transparent border-0"><i class="ri-search-line"></i></button>
              </form>
            </div>
            <div class="sidebar-widget category-widget bg-gray round-10">
              <h3 class="sidebar-widget-title fs-18 fw-semibold text-title mb-15">Categories</h3>
              <ul class="list-unstyled mb-0">
                {categories.map(cat => {
                  const count = categoryCounts.get(cat.id) || 0;
                  return (
                    <li>
                      <a href={`/news?category=${cat.slug}`} class="position-relative">
                        <i class="ri-arrow-right-s-line position-absolute"></i>
                        {cat.name} <span>({count})</span>
                      </a>
                    </li>
                  );
                })}
              </ul>
            </div>
            <div class="sidebar-widget category-widget bg-gray round-10">
              <h3 class="sidebar-widget-title fs-18 fw-semibold text-title mb-15">Recent Posts</h3>
              <div class="rp-post-wrap">
                {recentPosts.map(post => (
                  <div class="rp-post-card d-flex flex-wrap align-items-center">
                    <div class="rp-post-img">
                      <img src={post.image} alt="Post Thumb">
                    </div>
                    <div class="rp-post-info">
                      <a href={`/news/${post.slug}`} class="fs-15 fw-medium text_primary link-hover-primary d-block mb-1">{post.date}</a>
                      <h5 class="fs-15 fw-bold mb-0">
                        <a href={`/news/${post.slug}`} class="text-title hover-text-primary transition">{post.title}</a>
                      </h5>
                    </div>
                  </div>
                ))}
              </div>
            </div>
            <div class="sidebar-widget tags-widget bg-gray round-10">
              <h3 class="sidebar-widget-title fs-18 fw-semibold text-title mb-15">Tags</h3>
              <ul class="list-unstyled mb-0">
                <li><a href="/news">Business</a></li>
                <li><a href="/news">Development</a></li>
                <li><a href="/news">Design</a></li>
                <li><a href="/news">Marketing</a></li>
                <li><a href="/news">Real Estate</a></li>
              </ul>
            </div>
          </aside>
        </div>

        <div class="col-xl-8 order-xl-2 order-1">
          <div class="blog-desc">
          
            <h1 class="font-secondary mb-2">{title}</h1>
            <ul class="blog-metainfo list-unstyled mb-20 d-flex flex-wrap align-items-center gap-3">
              <li class="fs-15 d-inline-flex align-items-center gap-2 position-relative">
                {image && (
                  <img src={image} alt={author} class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">
                )}
                By <a href="/news">{author}</a>
              </li>
              <li class="fs-15 d-inline-block position-relative">{category}</li>
            </ul>
            <div class="single-img position-relative round-10 mb-35">
              <img src={image} alt="Blog" class="round-10">
              <a href="/news" class="blog-date bg-white text-title position-absolute d-flex flex-column align-items-center justify-content-center round-10">
                <span class="font-secondary fs-24 fw-black d-block">{displayDay}</span>{displayMonth}
              </a>
            </div>
            <div class="single-para">
              {content ? (
                <Fragment set:html={content}></Fragment>
              ) : (
                <>
                  <h6>Overview & Challenge</h6>
                  <p>Renius Real Estate & Construction Group, we believe knowledge empowers better decisionsâ€”whether you're investing in property, managing a build, or exploring industry trends. Our blog is a dedicated space where we share expert insights, project highlights, market updates, and thought leadership on real estate and construction.</p>
                  <p>Whether you're a client, partner, or industry professional, you'll find valuable content that helps you stay informed and make smarter decisions in the world of real estate and construction.</p>
                 
                  <h6 class="mt-4">Worker Productivity due to Safety Concerns</h6>
                  <p>begins with a commitment to excellence. From initial planning to final handover, our team works with precision, transparency, and dedication to deliver spaces that serve both function and vision. Backed by years of industry expertise and a deep understanding build as an opportunity to shape communities</p>
                </>
              )}
            </div>
          </div>

          <div class="post-metaoption bg-white mb-40 round-15">
            <div class="row align-items-center">
              <div class="col-md-6">
                <div class="post-tag d-flex fle-wrap align-items-center mb-sm-20">
                  <span class="text-title me-3">Tags</span>
                  <ul class="tag-list style-two list-unstyled mb-0">
                    <li><a href="/news">News</a>,</li>
                    <li><a href="/news">Business</a>,</li>
                    <li><a href="/news">{category}</a></li>
                  </ul>
                </div>
              </div>
              <div class="col-md-6">
                <div class="post-share d-flex flex-wrap align-items-center justify-content-md-end">
                  <span class="text-para fw-semibold me-2">Share:</span>
                  <ul class="social-profile style-one list-unstyled mb-0">
                    <li><a href="https://www.facebook.com/" target="_blank" class="d-flex flex-column align-items-center justify-content-center rounded-circle"><i class="ri-facebook-fill"></i></a></li>
                    <li><a href="https://x.com/?lang=en" target="_blank" class="d-flex flex-column align-items-center justify-content-center rounded-circle"><i class="ri-twitter-x-line"></i></a></li>
                    <li><a href="https://www.instagram.com/" target="_blank" class="d-flex flex-column align-items-center justify-content-center rounded-circle"><i class="ri-instagram-line"></i></a></li>
                    <li><a href="https://www.linkedin.com/" target="_blank" class="d-flex flex-column align-items-center justify-content-center rounded-circle"><i class="ri-linkedin-fill"></i></a></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          {relatedPosts.length > 0 && (
            <h4 class="fs-20 fw-bold text-title mb-25">Related Articles</h4>
          )}
          {relatedPosts.length > 0 && (
            <div class="row g-4 mb-50">
              {relatedPosts.map(post => (
                <div class="col-lg-4 col-md-6">
                  <article class="blog-card">
                    <div class="blog-thumb mb-3">
                      <img src={post.image} alt="Article" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px;">
                    </div>
                    <div class="blog-meta text-sm text-gray-500 mb-2">
                      <span>{post.date}</span>
                    </div>
                    <h5>
                      <a href={`/news/${post.slug}`} class="text-title hover-text-primary transition">{post.title}</a>
                    </h5>
                  </article>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
    <!-- Blog Details End -->

    <!-- Footer Section Start -->
    <Footer />
    <!-- Footer End -->
  </div>
</Layout>

